name: Build (Windows CMake)

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure and build with CMake
        shell: pwsh
        run: |
          Write-Host "Configuring CMake (x64, Release)..."
          New-Item -ItemType Directory -Force -Path build | Out-Null
          cmake -S . -B build -A x64 -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release --parallel

          # Locate outputs and copy to workspace root for artifact upload
          $possibleExe = "build/Release/PrivDialogExe.exe"
          $possibleDll = "build/Release/PrivDialogDll.dll"
          if (-not (Test-Path $possibleExe)) { $possibleExe = "build/PrivDialogExe.exe" }
          if (-not (Test-Path $possibleDll)) { $possibleDll = "build/PrivDialogDll.dll" }

          if (Test-Path $possibleExe) { Copy-Item $possibleExe -Destination PrivDialogExe.exe -Force; Write-Host "Copied EXE" }
          else { Write-Host "EXE not found in expected locations" }

          if (Test-Path $possibleDll) { Copy-Item $possibleDll -Destination PrivDialogDll.dll -Force; Write-Host "Copied DLL" }
          else { Write-Host "DLL not found in expected locations" }

          # Try to find import lib
          $lib = Get-ChildItem build -Filter "*.lib" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($lib) { Copy-Item $lib.FullName -Destination PrivDialogDll.lib -Force; Write-Host "Copied import lib" }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: privdialog-binaries
          path: |
            PrivDialogDll.dll
            PrivDialogDll.lib
            PrivDialogExe.exe
